from collections import OrderedDict
import io
import csv

#
# Column names from:
# http://www.gks.ru/opendata/storage/7708234640-bdboo2013/structure-20131231t000000.TTL
#

DOC_NAMES = """     1, Наименование                                      , C, 1000
     2, ОКПО                                              , C,    8
     3, ОКОПФ                                             , C,    5
     4, ОКФС                                              , C,    2
     5, ОКВЭД                                             , C,    8
     6, ИНН                                               , C,   10
     7, Код единицы измерения                             , C,    3
     8, Тип отчета                                        , C,    1
     9, 11103                                             , N,   15
    10, 11104                                             , N,   15
    11, 11203                                             , N,   15
    12, 11204                                             , N,   15
    13, 11303                                             , N,   15
    14, 11304                                             , N,   15
    15, 11403                                             , N,   15
    16, 11404                                             , N,   15
    17, 11503                                             , N,   15
    18, 11504                                             , N,   15
    19, 11603                                             , N,   15
    20, 11604                                             , N,   15
    21, 11703                                             , N,   15
    22, 11704                                             , N,   15
    23, 11803                                             , N,   15
    24, 11804                                             , N,   15
    25, 11903                                             , N,   15
    26, 11904                                             , N,   15
    27, 11003                                             , N,   15
    28, 11004                                             , N,   15
    29, 12103                                             , N,   15
    30, 12104                                             , N,   15
    31, 12203                                             , N,   15
    32, 12204                                             , N,   15
    33, 12303                                             , N,   15
    34, 12304                                             , N,   15
    35, 12403                                             , N,   15
    36, 12404                                             , N,   15
    37, 12503                                             , N,   15
    38, 12504                                             , N,   15
    39, 12603                                             , N,   15
    40, 12604                                             , N,   15
    41, 12003                                             , N,   15
    42, 12004                                             , N,   15
    43, 16003                                             , N,   15
    44, 16004                                             , N,   15
    45, 13103                                             , N,   15
    46, 13104                                             , N,   15
    47, 13203                                             , N,   15
    48, 13204                                             , N,   15
    49, 13403                                             , N,   15
    50, 13404                                             , N,   15
    51, 13503                                             , N,   15
    52, 13504                                             , N,   15
    53, 13603                                             , N,   15
    54, 13604                                             , N,   15
    55, 13703                                             , N,   15
    56, 13704                                             , N,   15
    57, 13003                                             , N,   15
    58, 13004                                             , N,   15
    59, 14103                                             , N,   15
    60, 14104                                             , N,   15
    61, 14203                                             , N,   15
    62, 14204                                             , N,   15
    63, 14303                                             , N,   15
    64, 14304                                             , N,   15
    65, 14503                                             , N,   15
    66, 14504                                             , N,   15
    67, 14003                                             , N,   15
    68, 14004                                             , N,   15
    69, 15103                                             , N,   15
    70, 15104                                             , N,   15
    71, 15203                                             , N,   15
    72, 15204                                             , N,   15
    73, 15303                                             , N,   15
    74, 15304                                             , N,   15
    75, 15403                                             , N,   15
    76, 15404                                             , N,   15
    77, 15503                                             , N,   15
    78, 15504                                             , N,   15
    79, 15003                                             , N,   15
    80, 15004                                             , N,   15
    81, 17003                                             , N,   15
    82, 17004                                             , N,   15
    83, 21103                                             , N,   15
    84, 21104                                             , N,   15
    85, 21203                                             , N,   15
    86, 21204                                             , N,   15
    87, 21003                                             , N,   15
    88, 21004                                             , N,   15
    89, 22103                                             , N,   15
    90, 22104                                             , N,   15
    91, 22203                                             , N,   15
    92, 22204                                             , N,   15
    93, 22003                                             , N,   15
    94, 22004                                             , N,   15
    95, 23103                                             , N,   15
    96, 23104                                             , N,   15
    97, 23203                                             , N,   15
    98, 23204                                             , N,   15
    99, 23303                                             , N,   15
   100, 23304                                             , N,   15
   101, 23403                                             , N,   15
   102, 23404                                             , N,   15
   103, 23503                                             , N,   15
   104, 23504                                             , N,   15
   105, 23003                                             , N,   15
   106, 23004                                             , N,   15
   107, 24103                                             , N,   15
   108, 24104                                             , N,   15
   109, 24213                                             , N,   15
   110, 24214                                             , N,   15
   111, 24303                                             , N,   15
   112, 24304                                             , N,   15
   113, 24503                                             , N,   15
   114, 24504                                             , N,   15
   115, 24603                                             , N,   15
   116, 24604                                             , N,   15
   117, 24003                                             , N,   15
   118, 24004                                             , N,   15
   119, 25103                                             , N,   15
   120, 25104                                             , N,   15
   121, 25203                                             , N,   15
   122, 25204                                             , N,   15
   123, 25003                                             , N,   15
   124, 25004                                             , N,   15
   125, 32003                                             , N,   15
   126, 32004                                             , N,   15
   127, 32005                                             , N,   15
   128, 32006                                             , N,   15
   129, 32007                                             , N,   15
   130, 32008                                             , N,   15
   131, 33103                                             , N,   15
   132, 33104                                             , N,   15
   133, 33105                                             , N,   15
   134, 33106                                             , N,   15
   135, 33107                                             , N,   15
   136, 33108                                             , N,   15
   137, 33117                                             , N,   15
   138, 33118                                             , N,   15
   139, 33125                                             , N,   15
   140, 33127                                             , N,   15
   141, 33128                                             , N,   15
   142, 33135                                             , N,   15
   143, 33137                                             , N,   15
   144, 33138                                             , N,   15
   145, 33143                                             , N,   15
   146, 33144                                             , N,   15
   147, 33145                                             , N,   15
   148, 33148                                             , N,   15
   149, 33153                                             , N,   15
   150, 33154                                             , N,   15
   151, 33155                                             , N,   15
   152, 33157                                             , N,   15
   153, 33163                                             , N,   15
   154, 33164                                             , N,   15
   155, 33165                                             , N,   15
   156, 33166                                             , N,   15
   157, 33167                                             , N,   15
   158, 33168                                             , N,   15
   159, 33203                                             , N,   15
   160, 33204                                             , N,   15
   161, 33205                                             , N,   15
   162, 33206                                             , N,   15
   163, 33207                                             , N,   15
   164, 33208                                             , N,   15
   165, 33217                                             , N,   15
   166, 33218                                             , N,   15
   167, 33225                                             , N,   15
   168, 33227                                             , N,   15
   169, 33228                                             , N,   15
   170, 33235                                             , N,   15
   171, 33237                                             , N,   15
   172, 33238                                             , N,   15
   173, 33243                                             , N,   15
   174, 33244                                             , N,   15
   175, 33245                                             , N,   15
   176, 33247                                             , N,   15
   177, 33248                                             , N,   15
   178, 33253                                             , N,   15
   179, 33254                                             , N,   15
   180, 33255                                             , N,   15
   181, 33257                                             , N,   15
   182, 33258                                             , N,   15
   183, 33263                                             , N,   15
   184, 33264                                             , N,   15
   185, 33265                                             , N,   15
   186, 33266                                             , N,   15
   187, 33267                                             , N,   15
   188, 33268                                             , N,   15
   189, 33277                                             , N,   15
   190, 33278                                             , N,   15
   191, 33305                                             , N,   15
   192, 33306                                             , N,   15
   193, 33307                                             , N,   15
   194, 33406                                             , N,   15
   195, 33407                                             , N,   15
   196, 33003                                             , N,   15
   197, 33004                                             , N,   15
   198, 33005                                             , N,   15
   199, 33006                                             , N,   15
   200, 33007                                             , N,   15
   201, 33008                                             , N,   15
   202, 36003                                             , N,   15
   203, 36004                                             , N,   15
   204, 41103                                             , N,   15
   205, 41113                                             , N,   15
   206, 41123                                             , N,   15
   207, 41133                                             , N,   15
   208, 41193                                             , N,   15
   209, 41203                                             , N,   15
   210, 41213                                             , N,   15
   211, 41223                                             , N,   15
   212, 41233                                             , N,   15
   213, 41243                                             , N,   15
   214, 41293                                             , N,   15
   215, 41003                                             , N,   15
   216, 42103                                             , N,   15
   217, 42113                                             , N,   15
   218, 42123                                             , N,   15
   219, 42133                                             , N,   15
   220, 42143                                             , N,   15
   221, 42193                                             , N,   15
   222, 42203                                             , N,   15
   223, 42213                                             , N,   15
   224, 42223                                             , N,   15
   225, 42233                                             , N,   15
   226, 42243                                             , N,   15
   227, 42293                                             , N,   15
   228, 42003                                             , N,   15
   229, 43103                                             , N,   15
   230, 43113                                             , N,   15
   231, 43123                                             , N,   15
   232, 43133                                             , N,   15
   233, 43143                                             , N,   15
   234, 43193                                             , N,   15
   235, 43203                                             , N,   15
   236, 43213                                             , N,   15
   237, 43223                                             , N,   15
   238, 43233                                             , N,   15
   239, 43293                                             , N,   15
   240, 43003                                             , N,   15
   241, 44003                                             , N,   15
   242, 44903                                             , N,   15
   243, 61003                                             , N,   15
   244, 62103                                             , N,   15
   245, 62153                                             , N,   15
   246, 62203                                             , N,   15
   247, 62303                                             , N,   15
   248, 62403                                             , N,   15
   249, 62503                                             , N,   15
   250, 62003                                             , N,   15
   251, 63103                                             , N,   15
   252, 63113                                             , N,   15
   253, 63123                                             , N,   15
   254, 63133                                             , N,   15
   255, 63203                                             , N,   15
   256, 63213                                             , N,   15
   257, 63223                                             , N,   15
   258, 63233                                             , N,   15
   259, 63243                                             , N,   15
   260, 63253                                             , N,   15
   261, 63263                                             , N,   15
   262, 63303                                             , N,   15
   263, 63503                                             , N,   15
   264, 63003                                             , N,   15
   265, 64003                                             , N,   15"""


def yeild_colnames():
    with io.StringIO(DOC_NAMES) as csvfile:
        spamreader = csv.reader(csvfile, delimiter=",")
        for row in spamreader:
            yield(row[1].strip())
COLNAMES = list(yeild_colnames())


# ['Наименование', 'ОКПО', 'ОКОПФ', 'ОКФС', 'ОКВЭД', 'ИНН', 'Код единицы измерения', 'Тип отчета']
# 'okfs' - формы собственности 
firm_attributes      = ['name', 'okpo', 'okopf', 'okfs', 'okved', 'inn', 'unit', 'report_type' ]
firm_attribute_types = [   str,    int,     int,    int,     str,   str,    int,           int ]
firm_attr = OrderedDict(zip(firm_attributes,firm_attribute_types))
 
firm_int_fields = [        'okpo', 'okopf', 'okfs',          'inn', 'unit', 'report_type']

COLNAMES[0:8] = firm_attributes 
assert COLNAMES[7] == 'report_type'
assert COLNAMES[8] == '11103'

# баланс
ap  = [x for x in COLNAMES if x.startswith("1")]

# отчет о прибыли и убытках
opu = [x for x in COLNAMES if x.startswith("2")] 

# отчет о движении денежных средств
cf  = [x for x in COLNAMES if x.startswith("4")] 

# отчет о движении капитала
dk  = [x for x in COLNAMES if x.startswith("3")] 

# отчет о целевых расходах
tsel  = [x for x in COLNAMES if x.startswith("6")] 

cur_year_data_labels  = [x for x in ap+opu+cf if x.endswith("3")]
prev_year_data_labels = [x for x in ap+opu+cf if x.endswith("4")]
current = cur_year_data_labels
prev = prev_year_data_labels
firm = firm_attributes

assert sorted(firm_attributes + cur_year_data_labels + prev_year_data_labels+dk+tsel) == sorted(COLNAMES) 
assert ap+opu+dk+cf+tsel == COLNAMES[8:]
assert firm_attributes+ap+opu+dk+cf+tsel == COLNAMES





#
#   Create files with fewer columns
#
#
#   Variable names as seen at 
#   http://info.avtovaz.ru/files/avtovaz_ras_12m_2013.pdf
#

rename =  OrderedDict([
 ('year', 'year'), 
 ('okved1', 'okved1'), 
 ('region', 'region'), 
 ('title', 'title'),
 ('inn', 'inn'), 
 ('1110', '1110'),
 ('1120', '1120'),
 ('1130', '1130'),
 ('1140', '1140'),
 ('1150', 'of'),   # основные средства
 ('1160', '1160'),
 ('1170', '1170'),
 ('1180', '1180'),
 ('1190', '1190'),
 ('1100', 'ta_fix'), #внеоборотные активы

 ('1210', '1210'),
 ('1220', '1220'),
 ('1230', '1230'),
 ('1240', '1240'),
 ('1250', '1250'),
 ('1260', '1260'),
 ('1200', 'ta_nonfix'), #оборотные активы

 ('1600', 'ta'), # активы всего

 ('1310', '1310'),
 ('1320', '1320'),
 ('1340', '1340'),
 ('1350', '1350'),
 ('1360', '1360'),
 ('1370', '1370'),
 ('1300', 'tp_cap'), # капитал

 ('1410', 'debt_long'), # долгосрочные займы
 ('1420', '1420'),
 ('1430', '1430'),
 ('1450', '1450'),
 ('1400', 'tp_long'), #долгосрочные обязательства 

 ('1510', 'debt_short'), # кракосрочные займы
 ('1520', '1520'),
 ('1530', '1530'),
 ('1540', '1540'),
 ('1550', '1550'),
 ('1500', 'tp_short'), #краткосрочные обязательства 
 
 ('1700', 'tp'),    # пассивы всего 
 
 ('2110', 'sales'), # выручка
 ('2120', '2120'),
 ('2100', '2100'),
 ('2210', '2210'),
 ('2220', '2220'),
 ('2200', 'profit_operational'), #прибыль от продаж
 ('2310', '2310'),
 ('2320', '2320'),
 ('2330', 'exp_interest'), # процентные платежи 
 ('2340', '2340'),
 ('2350', '2350'),
 ('2300', 'profit_before_tax'), #прибыль до налогообложения

 ('2410', '2410'),
 ('2421', '2421'),
 ('2430', '2430'),
 ('2450', '2450'),
 ('2460', '2460'),
 ('2400', '2400'),

 ('2510', '2510'),
 ('2520', '2520'),
 ('2500', '2500'),

 ('4110', 'cash_oper_inflow'),        # вcего операционные поступления
 ('4111', 'cash_oper_inflow_sales'),  # поступления от продаж
 ('4112', '4112'),
 ('4113', '4113'),
 ('4119', '4119'),
 ('4120', '4120'),
 ('4121', 'paid_to_supplier'),  # платежи поставщикам
 ('4122', 'paid_to_worker'),    # платежи работникам
 ('4123', 'cash_interest'),     # процентные платежи  
 ('4124', '4124'),
 ('4129', '4129'),
 ('4100', '4100'),

 ('4210', '4210'),
 ('4211', '4211'),
 ('4212', '4212'),
 ('4213', '4213'),
 ('4214', '4214'),
 ('4219', '4219'),
 ('4220', '4220'),
 ('4221', 'cash_investment_of'), # создание внеоборотных активов
 ('4222', '4222'),
 ('4223', '4223'),
 ('4224', '4224'),
 ('4229', '4229'),
 ('4200', '4200'),

 ('4310', '4310'),
 ('4311', '4311'),
 ('4312', '4312'),
 ('4313', '4313'),
 ('4314', '4314'),
 ('4319', '4319'),
 ('4320', '4320'),
 ('4321', '4321'),
 ('4322', '4322'),
 ('4323', '4323'),
 ('4329', '4329'),
 ('4300', '4300'),

 ('4400', '4400'),

 ('4490', '4490')]) # изменение, связанное с курсовой переоценкой
           
colname_to_varname_dict = OrderedDict([(k,v) for k,v in rename.items() if k!=v])  
